<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPPLE AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            background-color: #f0f0f0;
            overflow: hidden; /* Prevent body scroll */
            color: #333; /* Default text color */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1e1e1e; /* Dark background */
            color: #e0e0e0; /* Light text color */
        }

        body.dark-mode .pc-header,
        body.dark-mode .mobile-header,
        body.dark-mode .sidebar,
        body.dark-mode .input-container,
        body.dark-mode .settings-modal-content {
            background-color: #2d2d2d; /* Darker background for elements */
            border-color: #444; /* Darker border color */
            color: #e0e0e0;
        }

        body.dark-mode .sidebar-menu li:hover,
        body.dark-mode .chat-history li:hover {
            background-color: #3a3a3a; /* Darker hover effect */
        }

        body.dark-mode .sidebar-menu li.active,
        body.dark-mode .chat-history li.active {
             background-color: #4a4a4a; /* Darker active state */
        }

        body.dark-mode .chat-history li {
            background-color: #3a3a3a; /* Darker history item background */
            color: #e0e0e0;
        }

        body.dark-mode .main-content {
            background-color: #1e1e1e; /* Dark main content background */
        }

        body.dark-mode #initialText {
             color: #ccc; /* Lighter initial text color */
        }

        body.dark-mode .message.user {
             background-color: #3a3a3a; /* Darker user message background */
             color: #e0e0e0;
        }

         /* AI message text color in dark mode */
        body.dark-mode .message.ai {
             color: #e0e0e0; /* White text color for AI messages */
        }


        body.dark-mode .message.ai pre {
            background-color: #333; /* Darker code block background */
        }

        body.dark-mode .message.ai code {
            background-color: #444; /* Darker inline code background */
        }

        body.dark-mode .message.ai blockquote {
            border-left-color: #666; /* Darker blockquote border */
            color: #aaa; /* Lighter blockquote text */
        }

        body.dark-mode .message.ai table {
             border-color: #444;
        }

        body.dark-mode .message.ai th,
        body.dark-mode .message.ai td {
             border-color: #444;
        }

        body.dark-mode .message.ai th {
            background-color: #3a3a3a; /* Darker table header background */
        }

        body.dark-mode .message.ai tr:nth-child(even) {
            background-color: #2d2d2d; /* Darker even row background */
        }

        body.dark-mode .message.ai a {
             color: #89b4fa; /* Lighter link color */
        }

        body.dark-mode .message.ai hr {
             border-top-color: #444; /* Darker HR color */
        }

        body.dark-mode .input-container {
             background-color: #2d2d2d;
             border-color: #444;
        }

        body.dark-mode .input-container input,
        body.dark-mode .input-container textarea { /* Added textarea */
             background-color: #2d2d2d;
             color: #e0e0e0;
        }

        body.dark-mode .input-container button {
             background-color: #2d2d2d;
        }

         /* Icon color in dark mode */
        body.dark-mode .sidebar-menu li img,
        body.dark-mode .mobile-header .menu-button img,
        body.dark-mode .mobile-header .new-chat-mobile-button img,
        body.dark-mode .input-container button img,
        body.dark-mode .chat-history li .delete-button img {
             filter: invert(1); /* Invert icon color for dark mode */
        }


        body.dark-mode .functions-item {
             background-color: #3a3a3a;
             color: #e0e0e0;
             border-color: #444;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .functions-item:hover {
             background-color: #10a37f; /* Keep hover color consistent */
             color: white;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .suggestion-item {
             background-color: #3a3a3a;
             color: #e0e0e0;
        }

        body.dark-mode .suggestion-item:hover {
             background-color: #10a37f; /* Keep hover color consistent */
             color: white;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }


        /* PC Header with fixed logo */
        .pc-header {
            display: none; /* Hidden by default, shown on PC */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            justify-content: center; /* Center logo horizontally */
            align-items: center;
            z-index: 10;
             transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .pc-header img {
            height: 40px;
            width: auto;
        }

        /* Mobile Header */
        .mobile-header {
            display: flex; /* Shown by default on mobile */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 30; /* Higher than sidebar and overlay */
            justify-content: space-between; /* Space out menu, logo, new chat */
             transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Added style for mobile header logo */
        .mobile-header .header-logo {
            height: 40px; /* Match PC logo height */
            width: auto;
            display: block; /* Ensure it's treated as a block element */
        }


        .mobile-header .menu-button {
            /* Buttons are now inside the header, remove fixed positioning */
            position: static;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            z-index: auto; /* Remove specific z-index */
            margin-right: 40px; /* Added margin to push it right */
        }

        .mobile-header .new-chat-mobile-button {
             position: static;
             padding: 0;
             border: none;
             background: none;
             cursor: pointer;
             z-index: auto;
             margin-left: 10px; /* Added margin to push it left */
        }


        .mobile-header .menu-button img,
        .mobile-header .new-chat-mobile-button img {
            width: 24px;
            height: 24px;
            display: block;
        }


        /* Show PC header and hide mobile header on larger screens */
        @media (min-width: 769px) {
            .pc-header {
                display: flex; /* Show on PC */
            }
            .mobile-header {
                display: none; /* Hide on PC */
            }
             /* Adjust main content padding for fixed header and margin for sidebar */
             .main-content {
                 padding-top: 60px; /* Add space for the fixed PC header */
                 margin-left: 240px; /* Add margin for the sidebar */
             }
             /* Adjust input container position for fixed header and sidebar */
             /* Removed fixed left/right, now using max-width and margin auto within the available space */
        }


        /* Sidebar styles */
        .sidebar {
            width: 240px;
            background-color: #f7f7f8;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
            overflow-y: auto;
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; /* Smooth transition for mobile and dark mode */
            z-index: 20; /* Ensure sidebar is above content/overlay */
        }

        /* PC Sidebar positioning */
        @media (min-width: 769px) {
            .sidebar {
                position: fixed; /* Fix sidebar position */
                top: 60px; /* Position below the fixed PC header */
                bottom: 0; /* Extend to the bottom */
                left: 0; /* Align to the left */
                height: auto; /* Allow height to be determined by top/bottom */
                transform: translateX(0); /* Ensure it's visible */
                box-shadow: none; /* Remove mobile shadow */
                border-top: 1px solid #e0e0e0; /* Add top border for PC */
                padding-top: 20px; /* Restore padding top for PC sidebar */
            }
        }


        /* Mobile sidebar positioning */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 60px; /* Position below the mobile header */
                left: 0;
                height: calc(100vh - 60px); /* Fill remaining height below header */
                transform: translateX(-100%); /* Hide sidebar off-screen by default */
                box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Add shadow when open */
                padding-top: 20px; /* Restore padding top for mobile sidebar content */
            }
            .sidebar.open {
                transform: translateX(0); /* Slide in when open */
            }
        }


        /* sidebar-header is now only for the logo inside the sidebar on PC */
        .sidebar-header {
             display: flex; /* Show by default */
             align-items: center;
             justify-content: center; /* Center logo horizontally within sidebar */
             padding-bottom: 20px;
             border-bottom: 1px solid #e0e0e0;
             margin-bottom: 10px;
        }

        /* Hide sidebar header on mobile as logo is in mobile-header */
        @media (max-width: 768px) {
            .sidebar-header {
                display: none;
            }
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar-menu li {
            padding: 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
            border-radius: 5px;
        }

        .sidebar-menu li:hover {
            background-color: #f0f0f0;
        }

        .sidebar-menu li.active {
            background-color: #e0e0e0;
            font-weight: 600;
        }

        .sidebar-menu li img {
            margin-right: 8px;
            width: 20px;
            height: 20px;
        }

        /* Mobile sidebar menu item text - DO NOT HIDE TEXT */
         @media (max-width: 768px) {
             .sidebar-menu li span {
                 display: inline; /* Ensure text is displayed */
             }
             .sidebar-menu li img {
                 margin-right: 8px; /* Keep margin */
             }
             .sidebar-menu li {
                 justify-content: flex-start; /* Align items to start */
             }
         }


        /* Chat History Styles */
        .chat-history {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .chat-history li {
             padding: 8px 10px;
             cursor: pointer;
             margin-bottom: 5px;
             background-color: #e9e9eb;
             border-radius: 5px;
             font-size: 14px;
             color: #333;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             transition: background-color 0.2s ease;
             display: flex; /* Use flexbox to align text and delete button */
             justify-content: space-between; /* Space out text and button */
             align-items: center; /* Vertically center items */
        }

        .chat-history li:hover {
            background-color: #d0d0d0;
        }

        .chat-history li.active {
             background-color: #d0d0d0;
             font-weight: 600;
        }

        .chat-history li span {
            flex-grow: 1; /* Allow text to take up available space */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history li .delete-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 5px; /* Add some padding around the button */
            margin-left: 10px; /* Add space between text and button */
            opacity: 0; /* Hide delete button by default */
            transition: opacity 0.2s ease;
        }

        .chat-history li:hover .delete-button {
            opacity: 1; /* Show delete button on hover */
        }

        .chat-history li .delete-button img {
            width: 16px; /* Smaller icon for delete */
            height: 16px;
            display: block;
            margin-right: 0; /* Remove margin from icon */
        }


        /* Main content area */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            position: relative;
            overflow-y: auto; /* Allow main content to scroll */
            padding-bottom: 80px; /* Space for fixed input */
            transition: background-color 0.3s ease;
        }

         /* Adjust main content padding for mobile header */
         @media (max-width: 768px) {
             .main-content {
                 padding-top: 60px; /* Add space for the fixed mobile header */
                 margin-left: 0; /* Ensure no left margin on mobile */
             }
         }


        /* Custom Scrollbar Styles */
        .main-content::-webkit-scrollbar {
            width: 6px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 0;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 0;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: #808080;
        }

        .main-content {
            scrollbar-width: thin;
            scrollbar-color: #a0a0a0 transparent;
        }

        /* Initial text styling */
        #initialText {
            width: 100%;
            max-width: 90%; /* Adjusted max-width */
            text-align: center;
            font-size: 32px; /* Increased font size */
            font-weight: bold;
            color: #222;
            margin-bottom: 10px; /* Adjusted margin */
            padding-top: 100px; /* Increased padding-top to push it down */
            box-sizing: border-box;
            align-self: center;
             transition: color 0.3s ease;
        }

        /* Example conversations styling */
        .example-conversations {
            width: 100%;
            max-width: 768px; /* Match input container max-width */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center the examples */
            margin: 20px auto; /* Center horizontally and add top margin */
            padding: 0 20px;
            box-sizing: border-box;
            align-self: center;
        }

        .example-conversations h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #555;
             transition: color 0.3s ease;
        }

        .example-conversations ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%; /* Ensure ul takes full width of its container */
        }

        .example-conversations li {
            background-color: #f6f6f6;
            padding: 12px 20px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            text-align: center; /* Center the text in examples */
             transition: background-color 0.3s ease, color 0.3s ease;
        }

        .example-conversations li:hover {
            background-color: #f2f2f2;
        }

         /* Dark mode for examples */
         body.dark-mode .example-conversations h3 {
             color: #aaa;
         }

         body.dark-mode .example-conversations li {
             background-color: #3a3a3a;
             color: #e0e0e0;
         }

         body.dark-mode .example-conversations li:hover {
             background-color: #4a4a4a;
         }


        /* Chat container styling */
        .chat-container {
            width: 100%;
            max-width: 768px; /* Adjust max-width to a fixed pixel value or smaller percentage */
            display: flex;
            flex-direction: column;
            margin-top: 20px;
            flex-grow: 1;
            padding: 0 20px;
            box-sizing: border-box;
            align-self: center; /* Center the container */
        }

        /* Message styling */
        .message {
            padding: 12px 20px;
            border-radius: 20px;
            margin-bottom: 40px;
            font-size: 16px;
            color: #333;
            background-color: #fff;
            align-self: flex-start;
            position: relative;
            max-width: 95%; /* Adjusted max-width relative to chat-container */
            width: auto; /* Allow width to be determined by content */
            word-wrap: break-word;
        }

        .message.user {
            background-color: #f7f7f8;
            align-self: flex-end;
            border-radius: 999px; /* Default very rounded */
            transition: border-radius 0.3s ease; /* Smooth transition */
        }

        /* Less rounded style for user message when text is long */
        .message.user.less-rounded {
            border-radius: 20px; /* Less rounded, same as default message */
        }


        .message.ai {
            background-color: transparent;
            align-self: flex-start;
            border-top-left-radius: 0;
            padding: 0;
            box-shadow: none;
            width: 100%; /* Allow AI message container to take full width of chat-container */
        }

        /* Reset default margins/padding for elements within .message.ai */
        .message.ai b,
        .message.ai strong,
        .message.ai em,
        .message.ai code,
        .message.ai ul,
        .message.ai ol, /* Added ol */
        .message.ai blockquote,
        .message.ai pre,
        .message.ai li, /* li is included here */
        .message.ai table,
        .message.ai h1, .message.ai h2, .message.ai h3, .message.ai h4, .message.ai h5, .message.ai h6, /* Added headings */
        .message.ai p, .message.ai a, .message.ai img, .message.ai hr /* Added paragraph, link, image, hr */
         {
            margin: 0;
            padding: 0;
            /* Add specific padding/margin back in the markdown styles below */
        }

        /* Ensure list styles are applied within AI messages */
        .message.ai ul {
            list-style: disc !important; /* Changed list style to disc */
            padding-left: 20px !important; /* Ensure indentation */
            margin-top: 5px !important; /* Ensure margin */
            margin-bottom: 5px !important; /* Ensure margin */
        }
         .message.ai ol {
            list-style: decimal !important;
            padding-left: 20px !important;
            margin-top: 5px !important;
            margin-bottom: 5px !important;
         }
          .message.ai li {
              margin-bottom: 5px !important; /* Ensure margin between list items */
          }


        /* Styling for AI response markdown elements */
        .message.ai pre {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 10px;
            margin-bottom: 10px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
             transition: background-color 0.3s ease;
        }

        .message.ai code {
             background-color: #e9e9eb;
             padding: 2px 5px;
             border-radius: 4px;
             font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
             font-size: 0.9em;
             transition: background-color 0.3s ease;
        }

        .message.ai pre code {
             background-color: transparent;
             padding: 0;
             border-radius: 0;
        }

        .message.ai blockquote {
            border-left: 4px solid #ccc;
            margin: 10px 0;
            padding: 10px 15px;
            color: #666;
            font-style: italic;
             transition: border-left-color 0.3s ease, color 0.3s ease;
        }

        .message.ai table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            display: block;
             transition: border-color 0.3s ease;
        }

        .message.ai th,
        .message.ai td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
             transition: border-color 0.3s ease;
        }

        .message.ai th {
            background-color: #f2f2f2;
            font-weight: bold;
             transition: background-color 0.3s ease;
        }

        .message.ai tr:nth-child(even) {
            background-color: #f9f9f9;
             transition: background-color 0.3s ease;
        }

        .message.ai a { /* Added link styles */
            color: #1a73e8; /* Google Blue */
            text-decoration: none;
             transition: color 0.3s ease;
        }

        .message.ai a:hover {
            text-decoration: underline;
        }

        .message.ai img { /* Added image styles */
            max-width: 100%;
            height: auto;
            display: block; /* Prevent extra space below image */
            margin: 10px 0;
            border-radius: 8px;
        }

        .message.ai hr { /* Added horizontal rule styles */
            border: none;
            border-top: 1px solid #ccc;
            margin: 20px 0;
             transition: border-top-color 0.3s ease;
        }


        /* Arrow styling - Removed */
        .message::before {
            display: none;
        }


        /* Input container styling */
        .input-container {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 25px; /* Default rounded */
            padding: 5px 15px; /* Adjusted padding */
            align-items: center;
            background-color: #fff;
            position: fixed;
            bottom: 20px;
            box-sizing: border-box;
            z-index: 10;
            transition: background-color 0.3s ease, border-color 0.3s ease, border-radius 0.3s ease; /* Added border-radius transition */

            /* Added width and max-width to match chat container */
            width: calc(100% - 40px); /* Take full width minus 20px padding on each side on mobile */
            max-width: 768px; /* Match chat container max-width */
            margin: 0 auto; /* Center horizontally within the available space */
        }


        /* Adjust position for PC sidebar */
        @media (min-width: 769px) {
            .input-container {
                 /* Position it within the main content area's horizontal bounds */
                left: 240px; /* Start after the sidebar */
                right: 0; /* Go to the right edge of the viewport */
                width: calc(100% - 240px - 40px); /* Adjust width for sidebar and padding */
                /* margin: 0 auto; will then center the max-width element within this space */
            }
        }


        .input-container input,
        .input-container textarea { /* Added textarea */
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 10px 0; /* Adjusted padding */
            font-size: 16px;
            /* Removed border-radius here, handled by the container */
            background-color: #fff; /* Default background */
            color: #333; /* Default text color */
             transition: background-color 0.3s ease, color 0.3s ease;
            resize: none; /* Disable textarea resize handle */
            min-height: 24px; /* Adjusted minimum height to be lower */
            max-height: 120px; /* Maximum height before scrolling */
            overflow-y: auto; /* Add scrollbar when content exceeds max-height */
            line-height: 1.5; /* Adjust line height for readability */
            font-family: 'Inter', sans-serif; /* Ensure Inter font for input */
            box-sizing: border-box; /* Added box-sizing */
        }

        .input-container button {
            background-color: #fff;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            margin-left: 10px; /* Added left margin */
             transition: background-color 0.3s ease;
        }

        .input-container button img {
            width: 24px;
            height: 24px;
             transition: filter 0.3s ease;
        }

        /* Overlay when sidebar is open on mobile or settings modal is open */
        .overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
            z-index: 15; /* Below sidebar/settings modal, above main content */
        }

        .overlay.visible {
            display: block;
        }

        /* Settings Modal Styles */
        .settings-modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            z-index: 25; /* Above overlay */
        }

        .settings-modal.visible {
            display: flex;
        }

        .settings-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .settings-modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
             transition: border-bottom-color 0.3s ease;
        }

        .settings-modal-content .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
             transition: border-bottom-color 0.3s ease;
        }

        /* Remove border-bottom for the last setting item */
        .settings-modal-content .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Style for the setting item that contains the delete button */
        .settings-modal-content .setting-item.delete-all-setting {
            display: block; /* Change to block to allow button to take full width */
            text-align: center; /* Center the button horizontally */
            padding-top: 15px; /* Add padding above the button */
        }


        .settings-modal-content label {
            font-size: 1.1em;
        }

        .settings-modal-content .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
            line-height: 1;
            color: #aaa;
        }

        .settings-modal-content .close-button:hover {
            color: #666;
        }

        /* Toggle Switch Styles */
        .switch {
          position: relative;
          display: inline-block;
          width: 40px;
          height: 24px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
          border-radius: 24px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 16px;
          width: 16px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
          border-radius: 50%;
        }

        input:checked + .slider {
          background-color: #10a37f;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #10a37f;
        }

        input:checked + .slider:before {
          -webkit-transform: translateX(16px);
          -ms-transform: translateX(16px);
          transform: translateX(16px);
        }

        /* Delete All Button Style - Modified for full width */
        #deleteAllChatsButton {
            background-color: #f44336; /* Red background */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            width: 100%; /* Make button full width */
            text-align: center; /* Center text in button */
            margin-top: 0; /* Remove top margin */
            display: block; /* Ensure it takes full width */
        }

        #deleteAllChatsButton:hover {
            background-color: #d32f2f; /* Darker red on hover */
        }


        /* Functions and Suggestions - Kept original styling */
        .functions-wrapper {
            display: none;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .functions-item {
            background-color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            font-size: 16px;
            color: #333;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .functions-item:hover {
            background-color: #10a37f;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .suggestions {
            display: none;
            gap: 15px;
            margin-bottom: 0;
            justify-content: center;
        }

        .suggestion-item {
            background-color: #f0f0f0;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 14px;
            color: #555;
        }

        .suggestion-item:hover {
            background-color: #10a37f;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }


    </style>
</head>
<body>
    <div class="mobile-header">
        <div class="menu-button" id="menuButton">
            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/menu.svg" alt="메뉴">
        </div>
        <img src="https://i.postimg.cc/XvWHmKZt/001-78.png" alt="SUPPLE 로고" class="header-logo">
        <div class="new-chat-mobile-button" id="newChatMobileButton">
            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/plus.svg" alt="새 채팅">
        </div>
    </div>


    <div class="pc-header">
        <img src="https://i.postimg.cc/XvWHmKZt/001-78.png" alt="SUPPLE 로고">
    </div>

    <div class="sidebar" id="sidebar">
        <ul class="sidebar-menu">
            <li class="active">
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/message-square.svg" alt="메시지">
                <span>채팅</span>
            </li>
            <li>
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/zap.svg" alt="소라">
                <span>Sora</span>
            </li>
            <li>
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/book.svg" alt="라이브러리">
                <span>라이브러리</span>
            </li>
            <li>
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/code.svg" alt="HTML/CSS">
                <span>HTML/CSS</span>
             </li>
             <li>
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/play-circle.svg" alt="유튜브 영상">
                <span>유튜브 영상</span>
            </li>
            <li>
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/mic.svg" alt="GPT 음색">
                <span>GPT 음색</span>
            </li>
             <li id="settingsButton">
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/settings.svg" alt="설정">
                <span>설정</span>
            </li>
        </ul>
        <ul class="chat-history" id="chatHistory">
            </ul>
        <div class="sidebar-menu">
            <li id="newChatButton">
                <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/plus-circle.svg" alt="새 채팅">
                <span>새 채팅</span>
            </li>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <button class="close-button" id="closeSettingsButton">&times;</button>
            <h2>설정</h2>
            <div class="setting-item">
                <label for="darkModeToggle">다크 모드</label>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
             <div class="setting-item delete-all-setting">
                <button id="deleteAllChatsButton">모든 대화 삭제</button>
            </div>
            </div>
    </div>


    <div class="main-content" id="mainContent">
        <div id="initialText">무엇을 도와드릴까요?</div>
        <div class="example-conversations">
            <h3>이렇게 질문해보세요</h3>
            <ul>
                <li>생일파티 초대장 작성해줘.</li>
                <li>파이썬으로 "Hello, World!" 출력하는 코드 알려줘.</li>
                <li>우리나라 인구 수는 몇 명이니?</li>
            </ul>
        </div>
        <div class="chat-container" id="chatContainer">
            </div>
        </div>

    <div class="input-container" id="inputContainer">
        <textarea id="promptInput" placeholder="여기에 텍스트를 입력하세요"></textarea>
        <button id="sendButton">
            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/send.svg" alt="전송">
        </button>
    </div>


    <script>
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const chatContainer = document.getElementById('chatContainer');
        const initialTextElement = document.getElementById('initialText');
        const exampleConversationsElement = document.querySelector('.example-conversations'); // Get the example conversations container
        const chatHistoryElement = document.getElementById('chatHistory'); // Get the history list element
        const newChatButton = document.getElementById('newChatButton'); // Get the PC new chat button
        const newChatMobileButton = document.getElementById('newChatMobileButton'); // Get the Mobile new chat button
        const mainContent = document.getElementById('mainContent'); // Get the main content area for scrolling
        const sidebar = document.getElementById('sidebar'); // Get the sidebar element
        const menuButton = document.getElementById('menuButton'); // Get the menu button
        const overlay = document.getElementById('overlay'); // Get the overlay
        const settingsButton = document.getElementById('settingsButton'); // Get the settings button
        const settingsModal = document.getElementById('settingsModal'); // Get the settings modal
        const closeSettingsButton = document.getElementById('closeSettingsButton'); // Get the close settings button
        const darkModeToggle = document.getElementById('darkModeToggle'); // Get the dark mode toggle
        const inputContainer = document.getElementById('inputContainer'); // Get the input container div
        const deleteAllChatsButton = document.getElementById('deleteAllChatsButton'); // Get the delete all chats button


        const apiKey = 'AIzaSyCIg1Hlmhm4ZYPi6TtPBqkhXsJJsdXJfWY'; // 여기에 실제 API 키를 넣으세요. 이 부분을 발급받으신 키로 교체해주세요.

        // Array to store chat history data
        let chatHistory = [];
        // Variable to track the index of the currently active chat thread
        let currentChatIndex = -1;

        // Store the initial height of the textarea when it contains one line
        let initialTextareaHeight = 0; // Will be set on load

        // Save chat history and current index to localStorage
        function saveState() {
            try {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('currentChatIndex', currentChatIndex);
                console.log("Chat state saved to localStorage."); // Debugging log
            } catch (e) {
                console.error("Error saving chat state to localStorage:", e);
            }
        }

        // Load chat history and current index from localStorage
        function loadState() {
            try {
                const savedHistory = localStorage.getItem('chatHistory');
                const savedIndex = localStorage.getItem('currentChatIndex');
                console.log("Attempting to load chat state from localStorage."); // Debugging log

                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    console.log("Loaded chat history:", chatHistory); // Debugging log
                    displayChatHistory(); // Display loaded history in the sidebar

                    if (savedIndex !== null && chatHistory[savedIndex]) {
                        currentChatIndex = parseInt(savedIndex, 10);
                        console.log("Loaded current chat index:", currentChatIndex); // Debugging log
                        loadChatThread(currentChatIndex); // Load the last active chat thread
                    } else {
                         // If no valid index saved or chatHistory is empty, start fresh
                        console.log("No valid index or history empty, starting new chat."); // Debugging log
                        startNewChat();
                    }
                } else {
                     // If no history saved, start fresh
                    console.log("No chat history found, starting new chat."); // Debugging log
                    startNewChat();
                }

                // Load dark mode setting from localStorage
                loadDarkModeSetting();

            } catch (e) {
                console.error("Error loading chat state or settings from localStorage:", e);
                // Fallback to starting a new chat and default settings if loading fails
                startNewChat();
                applyDarkMode(false); // Default to light mode on error
            }
        }

        // Save dark mode setting to localStorage
        function saveDarkModeSetting(isDarkMode) {
            try {
                localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
                console.log("Dark mode setting saved:", isDarkMode); // Debugging log
            } catch (e) {
                console.error("Error saving dark mode setting to localStorage:", e);
            }
        }

        // Load dark mode setting from localStorage and apply
        function loadDarkModeSetting() {
            try {
                const savedMode = localStorage.getItem('darkMode');
                console.log("Loaded dark mode setting:", savedMode); // Debugging log
                const isDarkMode = savedMode === 'enabled';
                darkModeToggle.checked = isDarkMode; // Set the toggle state
                applyDarkMode(isDarkMode); // Apply the dark mode class
            } catch (e) {
                console.error("Error loading dark mode setting from localStorage:", e);
                // Default to light mode if loading fails
                darkModeToggle.checked = false;
                applyDarkMode(false);
            }
        }


        // Apply or remove dark mode class
        function applyDarkMode(isDarkMode) {
            console.log("applyDarkMode called with:", isDarkMode); // Debugging log
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                console.log("Added 'dark-mode' class to body."); // Debugging log
            } else {
                document.body.classList.remove('dark-mode');
                console.log("Removed 'dark-mode' class from body."); // Debugging log
            }
        }


        // Display chat history in the sidebar
        function displayChatHistory() {
            chatHistoryElement.innerHTML = ''; // Clear current history display
            chatHistory.forEach((historyItem, index) => {
                const listItem = document.createElement('li');
                // Display the first user message as the history item summary
                const firstUserMessage = historyItem.messages.find(msg => msg.role === 'user');
                const summaryText = firstUserMessage ? firstUserMessage.text : '새 대화';

                const textSpan = document.createElement('span');
                textSpan.textContent = summaryText.substring(0, 30) + (summaryText.length > 30 ? '...' : ''); // Truncate for summary

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x.svg" alt="삭제">'; // Use 'x' icon for delete
                deleteButton.title = '대화 삭제'; // Add tooltip

                // Add event listener to the delete button
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent click from triggering the loadChatThread on the li
                    console.log("Delete button clicked for index:", index); // Debugging log
                    deleteChatThread(index); // Call delete function with the index
                });


                listItem.appendChild(textSpan);
                listItem.appendChild(deleteButton);
                listItem.dataset.index = index; // Store index for loading full conversation

                // Add active class if this is the current chat
                if (index === currentChatIndex) {
                    listItem.classList.add('active');
                }

                // Add event listener to the list item itself to load the chat thread
                listItem.addEventListener('click', () => {
                    console.log("Chat history item clicked for index:", index); // Debugging log
                    loadChatThread(index); // Load the clicked conversation
                    closeMobileMenu(); // Close menu after selecting chat on mobile
                });
                chatHistoryElement.appendChild(listItem);
            });
        }

        // Function to delete a specific chat thread
        function deleteChatThread(index) {
            console.log("deleteChatThread called with index:", index); // Debugging log
            if (index >= 0 && index < chatHistory.length) {
                // Add confirmation before deleting
                if (confirm('이 대화를 정말 삭제하시겠습니까?')) {
                    console.log("Confirm delete: Yes"); // Debugging log
                    console.log("Chat history before splice:", JSON.parse(JSON.stringify(chatHistory))); // Debugging log
                    console.log("Current chat index before splice:", currentChatIndex); // Debugging log

                    chatHistory.splice(index, 1); // Remove the thread from the array

                    console.log("Chat history after splice:", JSON.parse(JSON.stringify(chatHistory))); // Debugging log

                    // Adjust currentChatIndex if the deleted thread was the active one or before it
                    if (index === currentChatIndex) {
                        console.log("Deleted current chat. Starting new chat."); // Debugging log
                        startNewChat(); // If the active chat was deleted, start a new one
                    } else if (index < currentChatIndex) {
                        console.log("Deleted chat before current. Decrementing current index."); // Debugging log
                        currentChatIndex--; // If a thread before the active one was deleted, decrement the index
                         saveState(); // Save the updated history and index
                         displayChatHistory(); // Refresh the sidebar display
                         // No need to load chat thread, as the current one is still active (at a new index)
                    } else {
                         console.log("Deleted chat after current or not current."); // Debugging log
                         saveState(); // Save the updated history and index
                         displayChatHistory(); // Refresh the sidebar display
                         // No change to currentChatIndex or current chat display needed
                    }


                    showMessageBox("대화가 삭제되었습니다."); // Show confirmation message
                } else {
                     console.log("Confirm delete: No"); // Debugging log
                }
            } else {
                 console.error("Invalid index provided to deleteChatThread:", index); // Debugging log
            }
        }

        // Function to delete ALL chat threads
        function deleteAllChatThreads() {
             console.log("deleteAllChatThreads called."); // Debugging log
             if (chatHistory.length === 0) {
                 showMessageBox("삭제할 대화가 없습니다.");
                 return;
             }
             if (confirm('모든 대화를 정말 삭제하시겠습니까?')) {
                 console.log("Confirm delete all: Yes"); // Debugging log
                 chatHistory = []; // Clear the entire array
                 currentChatIndex = -1; // Reset current index
                 saveState(); // Save the empty state
                 displayChatHistory(); // Clear the sidebar display
                 chatContainer.innerHTML = ''; // Clear the main chat area
                 initialTextElement.style.display = 'block'; // Show initial text
                 exampleConversationsElement.style.display = 'flex'; // Show examples
                 showMessageBox("모든 대화가 삭제되었습니다."); // Show confirmation
                 settingsModal.classList.remove('visible'); // Close settings modal
                 overlay.classList.remove('visible'); // Hide overlay
             } else {
                 console.log("Confirm delete all: No"); // Debugging log
             }
        }


        // Load a specific chat thread into the main chat area
        function loadChatThread(index) {
            console.log("loadChatThread called with index:", index); // Debugging log
            if (index >= 0 && index < chatHistory.length) {
                currentChatIndex = index;
                chatContainer.innerHTML = ''; // Clear current chat display
                initialTextElement.style.display = 'none'; // Hide initial text
                exampleConversationsElement.style.display = 'none'; // Hide examples

                const threadMessages = chatHistory[currentChatIndex].messages;
                threadMessages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', message.role);
                     // Use formatApiResponse for both user and AI messages for consistent markdown handling
                    messageElement.innerHTML = formatApiResponse(message.text, message.role);
                    chatContainer.appendChild(messageElement);

                    // After appending, check if it's a user message and apply less-rounded if needed
                    if (message.role === 'user') {
                        // Temporarily set height to auto to get true scrollHeight
                        messageElement.style.height = 'auto';
                        const messageScrollHeight = messageElement.scrollHeight;

                        // Get computed styles for line height calculation
                        const computedStyle = window.getComputedStyle(messageElement);
                        const lineHeight = parseFloat(computedStyle.lineHeight) || parseFloat(computedStyle.fontSize) * 1.2; // Fallback
                        const paddingHeight = parseFloat(computedStyle.paddingTop) + parseFloat(computedStyle.paddingBottom);
                        const estimatedSingleLineHeight = lineHeight + paddingHeight;

                        // Check if the message height is significantly more than one line
                        // Using a threshold slightly above single line height to account for padding/margins
                        if (messageScrollHeight > estimatedSingleLineHeight * 1.5) { // Threshold for more than 1 line
                             messageElement.classList.add('less-rounded');
                        }
                         // Reset height if it was changed
                        messageElement.style.height = ''; // Remove inline style
                    }
                });

                scrollToBottom(); // Scroll to bottom after loading thread
                saveState(); // Save the current index
                displayChatHistory(); // Update sidebar active state
            } else {
                // If the index is invalid (e.g., after deleting the last item), start a new chat
                console.error("Attempted to load invalid chat index:", index); // Debugging log
                startNewChat();
            }
        }

        // Start a new chat conversation
        function startNewChat() {
            console.log("startNewChat called."); // Debugging log
            chatContainer.innerHTML = ''; // Clear current chat display
            initialTextElement.style.display = 'block'; // Show initial text
            exampleConversationsElement.style.display = 'flex'; // Show examples
            currentChatIndex = -1; // No active chat thread initially
            saveState(); // Save the updated index
            displayChatHistory(); // Update sidebar (no active item)
            closeMobileMenu(); // Close menu after starting new chat on mobile
        }


        // Modified keydown listener for textarea
        promptInput.addEventListener('keydown', (event) => {
            // If Enter is pressed
            if (event.key === 'Enter') {
                // If Shift is also pressed, send the message
                if (event.shiftKey) {
                    event.preventDefault(); // Prevent default newline for Shift+Enter
                    sendMessage();
                } else {
                    // If only Enter is pressed, do nothing (allow default newline in textarea)
                    // No need to preventDefault here unless you want to stop the newline
                    // event.preventDefault(); // Uncomment this if you want to prevent newline on simple Enter
                }
            }
        });

        // Input event listener to adjust textarea height
        promptInput.addEventListener('input', () => {
            // Reset height to auto to correctly calculate scrollHeight
            promptInput.style.height = 'auto';
            const scrollHeight = promptInput.scrollHeight;

            // Adjust textarea height to fit content up to max-height
            promptInput.style.height = Math.min(scrollHeight, 120) + 'px'; // Use 120px max-height from CSS
            // Removed input container border-radius logic
        });

        // Added focus event listener to trigger height adjustment on focus
        promptInput.addEventListener('focus', () => {
            console.log("Textarea focused. Triggering input event for height adjustment."); // Debugging log
            const event = new Event('input');
            promptInput.dispatchEvent(event);
        });


        sendButton.addEventListener('click', sendMessage);
        newChatButton.addEventListener('click', startNewChat); // Add event listener to PC new chat button
        newChatMobileButton.addEventListener('click', startNewChat); // Add event listener to Mobile new chat button
        deleteAllChatsButton.addEventListener('click', deleteAllChatThreads); // Add event listener to delete all chats button


        // Add event listeners to example conversation items
        document.querySelectorAll('.example-conversations li').forEach(item => {
            item.addEventListener('click', () => {
                promptInput.value = item.textContent;
                // Trigger input event to adjust textarea height if needed
                const event = new Event('input');
                promptInput.dispatchEvent(event);
                promptInput.focus(); // Focus the input
            });
        });


        // Settings button event listeners
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('visible');
            overlay.classList.add('visible');
            closeMobileMenu(); // Close sidebar if open
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('visible');
            overlay.classList.remove('visible');
        });

        // Close settings modal or sidebar when clicking overlay
        overlay.addEventListener('click', () => {
             if (settingsModal.classList.contains('visible')) {
                 settingsModal.classList.remove('visible');
                 overlay.classList.remove('visible');
             } else if (sidebar.classList.contains('open')) {
                 closeMobileMenu();
             }
        });


        // Dark mode toggle event listener
        darkModeToggle.addEventListener('change', (event) => {
            console.log("Dark mode toggle changed:", event.target.checked); // Debugging log
            const isDarkMode = event.target.checked;
            applyDarkMode(isDarkMode);
            saveDarkModeSetting(isDarkMode); // Save the setting
        });


        // Mobile menu toggle functionality
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('visible');
        });

        // Function to close the mobile menu
        function closeMobileMenu() {
             sidebar.classList.remove('open');
             overlay.classList.remove('visible');
        }


        function sendMessage() {
            const prompt = promptInput.value;
            if (!prompt.trim()) {
                 // Use a simple message box instead of alert
                showMessageBox("질문을 입력해주세요.");
                return;
            }

            if (initialTextElement) {
                initialTextElement.style.display = 'none';
                exampleConversationsElement.style.display = 'none'; // Hide examples when starting chat
            }

            // If no active chat thread, create a new one
            if (currentChatIndex === -1) {
                chatHistory.push({ messages: [] });
                currentChatIndex = chatHistory.length - 1;
            }

            const userMessageElement = document.createElement('div');
            userMessageElement.classList.add('message', 'user');
            // Use formatApiResponse for user messages as well
            userMessageElement.innerHTML = formatApiResponse(prompt, 'user');
            chatContainer.appendChild(userMessageElement);

            // After appending, check its height and apply less-rounded if needed
            // Temporarily set height to auto to get true scrollHeight
            userMessageElement.style.height = 'auto';
            const messageScrollHeight = userMessageElement.scrollHeight;

            // Get computed styles for line height calculation
            const computedStyle = window.getComputedStyle(userMessageElement);
            const lineHeight = parseFloat(computedStyle.lineHeight) || parseFloat(computedStyle.fontSize) * 1.2; // Fallback
            const paddingHeight = parseFloat(computedStyle.paddingTop) + parseFloat(computedStyle.paddingBottom);
            const estimatedSingleLineHeight = lineHeight + paddingHeight;


            // Check if the message height is significantly more than one line
            if (messageScrollHeight > estimatedSingleLineHeight * 1.5) { // Threshold for more than 1 line
                 userMessageElement.classList.add('less-rounded');
            }
             // Reset height if it was changed
            userMessageElement.style.height = ''; // Remove inline style


            promptInput.value = ''; // Clear textarea after sending

            // Reset textarea height after sending
            promptInput.style.height = 'auto';


            scrollToBottom(); // Scroll to bottom after sending user message

            // Add user message to the current history thread
            chatHistory[currentChatIndex].messages.push({ role: 'user', text: prompt });
            saveState(); // Save history after adding user message
            displayChatHistory(); // Update sidebar display (adds new item if it's the first message of a new thread)


            getGeminiResponse(prompt);
        }

        // Improved markdown formatting function
        function formatApiResponse(text, role) {
            let formattedText = text;

            // Handle Code blocks (```) - Replace internal newlines with a placeholder
            formattedText = formattedText.replace(/```([\w\W]*?)```/g, (match, codeContent) => {
                const trimmedCode = codeContent.trim();
                const codeWithPlaceholders = trimmedCode.replace(/\n/g, '[[NEWLINE_IN_CODE]]');
                return `[[CODE_BLOCK_START]]${codeWithPlaceholders}[[CODE_BLOCK_END]]`; // Use block placeholders
            });

            // Split the text into lines based on original newlines
            const lines = formattedText.split('\n');
            let outputLines = [];
            let inList = false;
            let currentListTag = ''; // 'ul' or 'ol'

            lines.forEach(line => {
                const trimmedLine = line.trim();
                const isBullet = /^[*\-+]/.test(trimmedLine);
                const isOrdered = /^\d+\./.test(trimmedLine);
                const isListItem = isBullet || isOrdered;

                if (isListItem) {
                    const listTag = isOrdered ? 'ol' : 'ul';
                    // Remove the markdown list marker and leading/trailing spaces
                    const listItemContent = line.replace(/^[\*\-+]?\s+/, '').replace(/^\d+\.\s+/, '').trim();

                    if (!inList || currentListTag !== listTag) {
                        // If ending a previous list, close it
                        if (inList) {
                            outputLines.push(`</${currentListTag}>`);
                        }
                        // Start new list
                        currentListTag = listTag;
                        outputLines.push(`<${currentListTag}>`);
                        inList = true;
                    }
                    // Add list item
                    outputLines.push(`<li>${listItemContent}</li>`);
                } else {
                    // If we were in a list, close it
                    if (inList) {
                        outputLines.push(`</${currentListTag}>`);
                        inList = false;
                        currentListTag = '';
                    }
                    // Add non-list line content directly
                    outputLines.push(line);
                }
            });

            // Close the last list if still in one
            if (inList) {
                outputLines.push(`</${currentListTag}>`);
            }

            // Join lines back
            let finalHtml = outputLines.join('\n');

            // Handle other block-level elements (headings, blockquotes, HR) - Apply globally
            finalHtml = finalHtml.replace(/^######\s(.*)$/gm, '<h6>$1</h6>');
            finalHtml = finalHtml.replace(/^#####\s(.*)$/gm, '<h5>$1</h5>');
            finalHtml = finalHtml.replace(/^####\s(.*)$/gm, '<h4>$1</h4>');
            finalHtml = finalHtml.replace(/^###\s(.*)$/gm, '<h3>$1</h3>');
            finalHtml = finalHtml.replace(/^##\s(.*)$/gm, '<h2>$1</h2>');
            finalHtml = finalHtml.replace(/^#\s(.*)$/gm, '<h1>$1</h1>');

            finalHtml = finalHtml.replace(/^>\s(.*)$/gm, '<blockquote>$1</blockquote>');

            finalHtml = finalHtml.replace(/^[-*_]{3,}$/gm, '<hr>');

            // Handle Inline code (`) - Apply globally *after* block processing
            finalHtml = finalHtml.replace(/`(.*?)`/g, '<code>$1</code>');

            // Handle Bold text (**...**)
            finalHtml = finalHtml.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            // Handle Italic text (_..._)
            finalHtml = finalHtml.replace(/_(.*?)_/g, '<em>$1</em>');

            // Handle Links ([text](url))
            finalHtml = finalHtml.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Handle Images (![alt text](url))
            finalHtml = finalHtml.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">');

            // Handle Basic Table Handling (simplified)
             finalHtml = finalHtml.replace(/^(.*?\|.*?\|.*?)<br>[-|\s]+<br>((?:(?:.*?\|.*?\|.*?)(?:<br>|$))*)/gm, (match, headerRow, dataRows) => {
                 const headerCells = headerRow.split('|').map(cell => `<th>${cell.trim()}</th>`).join('');
                 let tableHtml = `<table><thead><tr>${headerCells}</tr></thead><tbody>`;
                 const rows = dataRows.split('<br>').filter(row => row.trim() !== '');
                 rows.forEach(row => {
                     const dataCells = row.split('|').map(cell => `<td>${cell.trim()}</td>`).join('');
                     tableHtml += `<tr>${dataCells}</tr>`;
                 });
                 tableHtml += `</tbody></table>`;
                 return tableHtml;
             });


            // Convert remaining newlines to <br>, but *not* inside <pre><code> blocks
            // Restore newlines inside code blocks from placeholders first
            finalHtml = finalHtml.replace(/\[\[NEWLINE_IN_CODE\]\]/g, '\n');
            // Now, convert other newlines to <br>
            finalHtml = finalHtml.replace(/\n/g, '<br>');

            // Restore CODE_BLOCK_START/END placeholders to pre/code tags
            finalHtml = finalHtml.replace(/\[\[CODE_BLOCK_START\]\]([\w\W]*?)\[\[CODE_BLOCK_END\]\]/g, '<pre><code>$1</code></pre>');


            return finalHtml;
        }

        // Function to smoothly scroll to the bottom of the chat container
        function scrollToBottom() {
             mainContent.scrollTo({
                 top: mainContent.scrollHeight,
                 behavior: 'smooth'
             });
         }


        // Simple message box function
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #e80000;
                color: #ffffff;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 100;            `;
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                document.body.removeChild(messageBox);
            }, 3000); // Remove after 3 seconds
        }

        // Load chat state (history and current index) and settings when the page loads
        window.onload = function() {
            console.log("Window loaded. Loading chat state and settings..."); // Debugging log
            loadState(); // This now includes loading dark mode setting
            // Set initial height after loading state and before dispatching input event
            promptInput.style.height = 'auto'; // Ensure auto height for correct initial measurement

            // Calculate initial height based on content, not a fixed min-height
            // Temporarily convert to textarea to get scrollHeight for initial measurement
            const tempTextarea = document.createElement('textarea');
            tempTextarea.style.visibility = 'hidden';
            tempTextarea.style.position = 'absolute';
            tempTextarea.style.left = '-9999px';
            tempTextarea.style.top = '-9999px';
            tempTextarea.style.width = promptInput.clientWidth + 'px'; // Match the input width
            tempTextarea.style.fontSize = window.getComputedStyle(promptInput).fontSize;
            tempTextarea.style.fontFamily = window.getComputedStyle(promptInput).fontFamily;
            tempTextarea.style.padding = window.getComputedStyle(promptInput).padding;
            tempTextarea.style.lineHeight = window.getComputedStyle(promptInput).lineHeight;
            tempTextarea.style.boxSizing = 'border-box'; // Match the actual textarea box-sizing
            tempTextarea.value = promptInput.value || promptInput.placeholder; // Use placeholder if no value
            document.body.appendChild(tempTextarea);
            initialTextareaHeight = tempTextarea.scrollHeight;
            document.body.removeChild(tempTextarea);


            // Trigger the input event logic once on load to adjust for saved text
            const event = new Event('input');
            promptInput.dispatchEvent(event);

        };


    </script>

        <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('Service Worker 등록됨:', reg.scope))
      .catch(err => console.error('Service Worker 등록 실패:', err));
  }
    </script>

</body>
</html>
